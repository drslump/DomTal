<!DOCTYPE html>  <html> <head>   <title>DomTal.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               DomTal.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>DomTal 2.0 - A TAL template parser for javascript.</p>

<p>copyright (c) 2005-2012 Iv√°n -DrSlump- Montes <a href="http://pollinimini.net">http://pollinimini.net</a></p>

<p>Distributed under the MIT license</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">){</span> <span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />

<h2>Credits</h2>

<ul>
<li>The script originated from work by Joachim Zobel <a href="http://www.heute-morgen.de/test/About_DOMTAL.html">http://www.heute-morgen.de/test/About_DOMTAL.html</a> (used with permission)</li>
</ul>

<h2>Known issues</h2>

<ul>
<li><p>This script uses the own browser to parse the html, so you must be carefull 
 with the validity of the code. A common mistake is to use the short syntax 
 <code>&lt;tag /&gt;</code> for elements which shouldn't according to the standard.
 It's always a good idea to use the full syntax (except for <code>&lt;br/&gt;</code> and <code>&lt;hr/&gt;</code>) 
 even when no content is defined.</p></li>
<li><p>In Internet Explorer the tal attributes (processors) can't be removed from
 the generated code although this shouldn't affect anything.</p></li>
</ul>

<h2>Differences with standard TAL</h2>

<ul>
<li>The default tales prefix/modifier is <em>js</em>, which resolves a basic javascript
statement instead of a simple path to a variable.</li>
<li>No support for <code>tal:block</code> element.</li>
<li>No support for <code>tal:on-error</code> processor.</li>
<li>No support for <code>Metal</code>, however a similar behaviour can be mimicked with
document fragments and common tal processors.</li>
<li><code>omit-tag</code> works a bit differently. If the tales expression evaluates to true 
the tag is removed and its contents shown, otherwise the tag is also shown.
This is an intended change and can be easily removed by creating a custom
wrapper for this processor.</li>
</ul>

<h2>TODO</h2>

<ul>
<li>Check for performance bottlenecks and memory leaks</li>
</ul>

<hr />

<h1>Usage</h1>

<p>First we need to have a template somewhere in the page. Be it as an html
 string, a containing element or a document fragment.</p>

<pre><code> &lt;div id="myTemplate" style="display: none"&gt;
     &lt;table&gt;
     &lt;tr&gt;
         &lt;th&gt;Username&lt;/th&gt;
         &lt;th&gt;E-Mail&lt;/th&gt;
     &lt;/tr&gt;
     &lt;tr tal:repeat="user users"
         tal:attributes="class js:${repeat.user.odd}?'odd':'even'"&gt;
         &lt;td tal:content="user.name"&gt;&lt;/td&gt;
         &lt;td&gt;${user.email}&lt;/td&gt;
     &lt;/tr&gt;
     &lt;/table&gt;
 &lt;/div&gt;
</code></pre>

<p>we could also use an html string, either as a javascript string literal or
 by using the script tag</p>

<pre><code> &lt;script type="template/domtal" id="myTemplate"&gt;&lt;![CDATA[
 &lt;table&gt;
 &lt;tr&gt;
     &lt;th&gt;Username&lt;/th&gt;
     &lt;th&gt;E-Mail&lt;/th&gt;
 &lt;/tr&gt;
 &lt;tr tal:repeat="user users"
     tal:attributes="class js:${repeat.user.odd}?'odd':'even'"&gt;
     &lt;td tal:content="user.name"&gt;&lt;/td&gt;
     &lt;td&gt;${user.email}&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/table&gt;
 ]]&gt;&lt;/script&gt;
</code></pre>

<p>next we need to create the template object and set the apropiate data. Note
 that we can create the data set anyway we want, even loading it with JSON or
 similar remoting methods.</p>

<pre><code> var tpl = new DomTal();
 tpl-&gt;set( 'users', [{
   name: 'Joe Black',
   email: 'jblack@yahoo.co.uk'
 }, {
   name: 'Mike Flowers',
   email: 'mike.flowers@aol.es'
 }]);
</code></pre>

<p>now we just need to assign our template to the parser, process it and get
 the result</p>

<pre><code> tpl.load( document.getElementById('myTemplate') );
 var out = tpl.run();
 // put the result on the page
 document.getElmentById('outUsers').appendChild( out );
</code></pre>

<p>And that's it. There a few more options but overall it's a pretty easy to
 use library.</p>

<h1>Customization</h1>

<h2>Creating a new processor</h2>

<p>To extend the available processors we only need to create (or redefine) a
 method in <em>DomTal.processors</em>. Be aware that the order in which the
 processor methods are defined in the code specify their priority. The
 standard ones are applied in this order:
   <code>define</code>, <code>condition</code>, <code>repeat</code>, <code>content</code>, <code>replace</code>, <code>attributes</code>, <code>omit-tag</code></p>

<p>The return value of a processor has meaning. If it returns <em>true</em> then the
 children elements of that node will be further processed, alternatively, if
 it returns <em>false</em> its children will be skipped.</p>

<p>We are going to create a new processor which will convert an array items to
 a set of LI elements. It'll apply a class named 'selected' to the LI whose
 key is equal to the second tales expression:</p>

<pre><code> &lt;ul tal:li="path.to.array selectedKey" /&gt;
</code></pre>

<p>The processor implementation:</p>

<pre><code> DomTal.prototype.processors.li = function (node, exp) {
     var tales, key, arr;

     exp = new ExpressionParser(exp);
     tales = exp.tales();
     key = exp.ident();

     tales = this.tales(tales);
     arr = this.makeIterable(tales);

     node.innerHTML = '';
     if (arr.count) {
         for (var i=0; i&lt;arr.count; i++) {
             var li = document.createElement('LI');
             if (arr.keys[i] == key)
                 li.setAttribute('class', 'selected');
             li.appendChild( document.createTextNode( arr.values[i] ) );
             node.appendChild( li );
         }
     }

     return false;
 }
</code></pre>

<p>The following expression with a data set of ['one', 'two', 'three']</p>

<pre><code> &lt;ul id="list" tal:li="data 1"&gt;
   &lt;li&gt;Test item&lt;/li&gt;
 &lt;/ul&gt;
</code></pre>

<p>will generate the following html</p>

<pre><code> &lt;ul id="list"&gt;
   &lt;li&gt;one&lt;/li&gt;
   &lt;li class="selected"&gt;two&lt;/li&gt;
   &lt;li&gt;three&lt;/li&gt;
 &lt;/ul&gt;
</code></pre>

<h2>Creating a new tales modifier</h2>

<p>We can also add our own <em>Tales</em> modifiers by extending the <em>DomTal.modifiers</em>
 object with new methods. The methods just take an argument with the
 expression to evaluate and should return the result of that argument.</p>

<p>In this example we are going to create a modifier which will evaluate to the string
 'odd' or 'even' based on the value of an expression.</p>

<pre><code> DomTal.prototype.modifiers.oddeven = function(exp) {
     var value;
     value = this.tales(exp);
     return (value % 2) ? 'odd' : 'even';
 }
</code></pre>

<p>then the following template</p>

<pre><code> &lt;span tal:attributes="class oddeven:3"&gt;foo&lt;/span&gt;
</code></pre>

<p>will produce</p>

<pre><code> &lt;span class="odd"&gt;foo&lt;/span&gt;
</code></pre>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>DomTal.ExpressionParser</h1>

<p>Helper class to parse an expression. It's pretty rudimentary but we don't need 
 anything fancy for the supported expression syntax.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">exp</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">seek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ofs</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="nx">ofs</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">len</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="nx">len</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">consume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">len</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remaining</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">consume</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>An expression ident has the same syntax rules as a javascript one</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ident</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rex</span><span class="p">(</span><span class="sr">/^\s*([A-Za-z$_][$\w]*)\s*/</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Only decimal numbers, no support for hex format or exponents</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">number</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rex</span><span class="p">(</span><span class="sr">/^\s*(-?([0-9]+|[0-9]*?\.[0-9]+))\s*/</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Matches a tales prefix (ie: string:hello world!)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rex</span><span class="p">(</span><span class="sr">/^\s*([_$\w]+)\s*:/</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>A tales expression is basically any valid javascript statement with special
threatment for spacing which behaves very similarly to how Javascript manages 
end of lines for statements without a semi colon.</p>

<p>The return value of this matcher is an array containing all the statements found. 
Normally it will be a single item but if the expression contains alternates (ie: foo | bar)
each alternate will be returned as an element of the array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tales</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">// 1: probable end, 2: confirmed end</span>
        <span class="nx">quoted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">balanced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> 
        <span class="nx">token</span><span class="p">,</span>
        <span class="nx">exp</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Fetch the next token</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rex</span><span class="p">(</span><span class="sr">/^([^(){}[\]&#39;&quot;\\|;:,\s]+|\s+|.)/</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If we are at the end of a statement and the next char is the start of a new one</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">===</span> <span class="nx">balanced</span> <span class="o">&amp;&amp;</span> <span class="nx">eos</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="sr">/^[\(&#39;&quot;$\w]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="o">-</span><span class="nx">token</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">switch</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;(&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;{&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;[&#39;</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span><span class="p">)</span> <span class="nx">balanced</span><span class="o">++</span><span class="p">;</span>
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;)&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;}&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;]&#39;</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span><span class="p">)</span> <span class="nx">balanced</span><span class="o">--</span><span class="p">;</span>
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;|&#39;</span><span class="o">:</span> 
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">===</span> <span class="nx">balanced</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Make sure it's not a double pipe (ie: var = foo || bar)</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">token</span> <span class="o">+=</span> <span class="s1">&#39;|&#39;</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
                        <span class="nx">exp</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;\\&#39;</span><span class="o">:</span>
                <span class="nx">token</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">consume</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">:</span>
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">quoted</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">quoted</span> <span class="o">===</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">quoted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="nx">eos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;;&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;,&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>A comma or semicolon only terminates a statement if non quoted and outside parens</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">===</span> <span class="nx">balanced</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">eos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39; &#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;\t&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>skip initial white space</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exp</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If we find a space after a probable end of statement we enforce it</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">eos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">eos</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>An identifier signals a probable end of a statement</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">eos</span> <span class="o">=</span> <span class="sr">/\w/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!==</span> <span class="s1">&#39;new&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Check if the parser has been signalled to terminate</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>If we haven't completed a valid statement error out</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">quoted</span> <span class="o">||</span> <span class="nx">balanced</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Add the string to the expression</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">exp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Add the last expression to the results</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>If nothing matched error out</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Always returns the 1st capture if available</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rex</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">rex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">str</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">indent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
        <span class="nx">idx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">===</span> <span class="nx">idx</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>skip white space</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">idx</span><span class="o">--</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">indent</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">ExpressionParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>WeightedList</h2>

<p>Helper class to keep the list of processors sorted based on a weight property</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">WeightedList</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">itm</span><span class="p">,</span> <span class="nx">weight</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">weights</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_weights</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">weights</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">weights</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">weight</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">weights</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">weight</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_map</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_items</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">weights</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">weight</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_map</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_items</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">itm</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_items</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_weights</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_map</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span>

<span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getByName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">proc</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">until</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">proc</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">proc</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasByName</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getByName</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_items</span><span class="p">,</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_map</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">map</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">],</span> <span class="nx">map</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Keeps looping while the return value is truly</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">WeightedList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">until</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">cont</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_items</span><span class="p">,</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_map</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">cont</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cont</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span> <span class="nx">map</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">],</span> <span class="nx">map</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> 
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h1>DomTal</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Constructor</h2>

<p>The TAL template parser class</p>

<ol>
<li>tpl    Optional, the template to load</li>
<li>data   Optional, the initial global variables to be used in the template</li>
<li><p>ns     Optional, the attributes namespace used in the template (by default is 'tal')</p>

<p>tpl = new DomTal('#mytpl', {test: 'foo'});</p></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">DomTal</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ns</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tpl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">tpl</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ns</span> <span class="o">=</span> <span class="nx">ns</span> <span class="o">?</span> <span class="nx">ns</span> <span class="o">:</span> <span class="s1">&#39;tal&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ns</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Setup the data bucket</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">data</span> <span class="o">?</span> <span class="nx">data</span> <span class="o">:</span> <span class="p">{}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Default modifier for tales expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">defMod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">modifiers</span><span class="p">.</span><span class="nx">js</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>Constants</h2>

<p>We compare with === so we can use an object to detect them </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DEFAULT</span> <span class="o">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="nx">CONTENT</span> <span class="o">:</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span>
    <span class="nx">REPLACE</span> <span class="o">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span>
    <span class="nx">PROXY</span>   <span class="o">:</span> <span class="s1">&#39;proxy&#39;</span>
<span class="p">};</span>

<span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">MAX</span>       <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">VERYHIGH</span>  <span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="nx">HIGH</span>      <span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">ABOVE</span>     <span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
    <span class="nx">AVERAGE</span>   <span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="nx">BELOW</span>     <span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="nx">LOW</span>       <span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
    <span class="nx">VERYLOW</span>   <span class="o">:</span> <span class="mi">700</span><span class="p">,</span>
    <span class="nx">MIN</span>       <span class="o">:</span> <span class="mi">1000</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Create some static caches to be shared among all instances</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">js</span><span class="o">:</span> <span class="p">{},</span> <span class="c1">// cache for compiled tales expressions</span>
    <span class="nx">div</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>By default we allow access to the global Javascript context. This allows
to use external helpers like underscore's function to work with arrays.
Override this property with your own object to limit access to the environment
from the templates.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">env</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h2>interpolate</h2>

<p>Interpolates the given text with the current set of variables.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">txt</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>copy the object scope var as local variable to be used in the regexp closure</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>we capture the char just before so we can skip escaped marks. ie: $${..}
return txt.replace(/(^|[^\$])\${([^}]+)}/gmi, function(str, prefix, path) {
supports one level of nested balanced braces (TODO: is this worth it?)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">txt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|[^\$])\$\{((?:[^{}]+|{[^{}]*})*)\}/gmi</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>

            <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">());</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">prefix</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Dom</span>
                <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">div</span><span class="p">;</span>
                <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h2>stringToDom</h2>

<p>Converts the given html text to a DOM Fragment</p>

<pre><code> var html = 'This is an &lt;em&gt;html&lt;/em&gt; string';
 var fragment = tpl.stringToDom( html );
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stringToDom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">html</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">div</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>let the browser parse the HTML string</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">div</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">div</span><span class="p">;</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>create a document fragment and copy in it the parsed elements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nx">div</span><span class="p">.</span><span class="nx">firstChild</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">fragment</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>makeIterable</h2>

<p>Returns an structure suited to be iterable from the supplied argument. This
 method is used by the <em>repeat</em> processor.</p>

<p>The returned iterable structure which looks like this</p>

<pre><code> {
     keys  : [], // the item keys as an array
     values: [], // the item values as an array
     count : 0   // the number of items
 }
</code></pre>

<p>If you need to handle some special objects you can extend this method to
 handle them, see the following example:</p>

<pre><code> // Create a new object
 function MyDOMTAL() {};
 // Relate the new object to DomTal by prototype inheritance
 MyDOMTAL.prototype = new DomTal();
 // Extend the makeIterable method
 MyDOMTAL.prototype.makeIterable = function( v ) {
     if ( typeof v === 'object' &amp;&amp; v.type === 'yourCustomObject') {
           // Create an iterable structure for your custom object
           YOUR CUSTOM CODE GOES HERE
       } else {
           // Just call the default method for native types
           return DomTal.prototype.makeIterable.call(this, v)
       }
 }

 var obj = { a: 'AAA', b: 'BBB' };
 var iter = tpl.makeIterable(obj);
 for (var i=0; i&lt;iter.count; i++)
     alert( 'Key: ' + iter.keys[i] + ' Value: ' + iter.values[i]);
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeIterable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">res</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;keys&#39;</span>  <span class="o">:</span> <span class="p">[],</span>
            <span class="s1">&#39;values&#39;</span><span class="o">:</span> <span class="p">[],</span>
            <span class="s1">&#39;count&#39;</span> <span class="o">:</span> <span class="mi">0</span>
        <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">bind</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeIterable</span><span class="p">(</span><span class="nx">res</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">res</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">res</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">res</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">k</span> <span class="p">);</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">res</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">res</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">res</span> <span class="p">);</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h2>get</h2>

<p>Fetchs the contents of a variable defined by its name. If the variable is not 
 found it returns <code>undefined</code>.</p>

<pre><code> v = tpl.get('user');
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span>
        <span class="nx">idx</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">idx</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">idx</span><span class="p">][</span><span class="nx">name</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">def</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h2>set</h2>

<p>Sets the contents of a variable in the template.</p>

<pre><code> tpl.set( 'user', {firstname:'Joe', lastname:'Black'} );
</code></pre>

<p>We can assign a bunch of new values skipping the name and passing just an 
 object as value. It will create variables for all of the object's properties.</p>

<pre><code> tpl.set( { name: 'Mike', age: 22, email: 'mike@foo.bar' } );
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">value</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h2>process</h2>

<p>Parses the given node element modifying it according to the template
 instructions. You can pass a Document Fragment, a containing element or a
 string.</p>

<p>Note: The root element passed shouldn't contain any processor since many
 processors rely on the <em>parentNode</em> to operate. Always use a Document
 Fragment or a containing element such as a simple DIV.</p>

<pre><code> tpl.process( myTemplateElement );
 document.getElementById('holder').appendChild( myTemplateElement );
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">node</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span>
        <span class="nx">attrsNo</span><span class="p">,</span>
        <span class="nx">anode</span><span class="p">,</span>
        <span class="nx">p</span><span class="p">,</span> <span class="nx">processors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">processors</span><span class="p">,</span>
        <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Create a new local data set for new scope</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">({});</span>


    <span class="kd">function</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="kd">function</span> <span class="nx">isNode</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">typeof</span> <span class="nx">o</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">o</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="kd">function</span> <span class="nx">insertMarker</span><span class="p">(</span><span class="nx">processor</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">m1</span><span class="p">,</span> <span class="nx">m2</span><span class="p">,</span>
            <span class="nx">ident</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000000</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fragment</span> <span class="o">||</span> <span class="o">!</span><span class="nx">fragment</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">m1</span> <span class="o">=</span> <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createComment</span><span class="p">(</span><span class="s1">&#39;DOMTAL:MARK id=&#39;</span> <span class="o">+</span> <span class="nx">ident</span> <span class="o">+</span> <span class="s1">&#39; processor=&#39;</span> <span class="o">+</span> <span class="nx">processor</span><span class="p">);</span>
            <span class="nx">m1</span><span class="p">.</span><span class="nx">ident</span> <span class="o">=</span> <span class="nx">ident</span><span class="p">;</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;mark&#39;</span><span class="p">;</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">processor</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">m1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createComment</span><span class="p">(</span><span class="s1">&#39;DOMTAL:BEGIN id=&#39;</span> <span class="o">+</span> <span class="nx">ident</span> <span class="o">+</span> <span class="s1">&#39; processor=&#39;</span> <span class="o">+</span> <span class="nx">processor</span><span class="p">);</span>
            <span class="nx">m1</span><span class="p">.</span><span class="nx">ident</span> <span class="o">=</span> <span class="nx">ident</span><span class="p">;</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;begin&#39;</span><span class="p">;</span> <span class="nx">m1</span><span class="p">.</span><span class="nx">processor</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">;</span>
            <span class="nx">fragment</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">m1</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>

            <span class="nx">m2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createComment</span><span class="p">(</span><span class="s1">&#39;DOMTAL:END id=&#39;</span> <span class="o">+</span> <span class="nx">ident</span> <span class="o">+</span> <span class="s1">&#39; processor=&#39;</span> <span class="o">+</span> <span class="nx">processor</span><span class="p">);</span>
            <span class="nx">m2</span><span class="p">.</span><span class="nx">ident</span> <span class="o">=</span> <span class="nx">ident</span><span class="p">;</span> <span class="nx">m2</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span><span class="p">;</span> <span class="nx">m2</span><span class="p">.</span><span class="nx">processor</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">;</span>
            <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">m2</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">fragment</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">m1</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Make a snapshot of a stack</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">makeSnapshot</span><span class="p">(</span><span class="nx">stack</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">snapshot</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">depth</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">depth</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">depth</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">snapshot</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">snapshot</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">depth</span><span class="p">][</span><span class="nx">k</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>TODO: Can we defer the backup creation until it's actually needed?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">bound</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">snapshot</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">backup</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">fn</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>text node</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Create a new dependency tracking context</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">bind</span><span class="p">.</span><span class="nx">tracking</span><span class="p">.</span><span class="nx">begin</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>interpolate any variable pressent in the raw text</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="p">);</span>

            <span class="kd">var</span> <span class="nx">deps</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">.</span><span class="nx">tracking</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
            <span class="nx">deps</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bound</span> <span class="o">&amp;&amp;</span> <span class="nx">deps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snapshot</span><span class="p">)</span> <span class="nx">makeSnapshot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>

                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Setting up computed for text node...&#39;</span><span class="p">);</span>
                <span class="nx">bound</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">backup</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">);</span>
                <span class="p">},</span> <span class="p">{</span><span class="nx">ctx</span><span class="o">:</span> <span class="k">this</span><span class="p">}).</span><span class="nx">depends</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
                <span class="nx">bound</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> 
                    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span> <span class="o">!==</span> <span class="nx">p</span><span class="p">)</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">dispose</span><span class="p">()</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;text bound disposed&#39;</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;text bound called&#39;</span><span class="p">);</span> 
                <span class="p">});</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>text nodes do not have child elements</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>element inside a container and with at least one attribute</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">attrsNo</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">ns</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ns</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>check each processor to see if it's defined in the node
for (p in processors) if (processors.hasOwnProperty(p)) {</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">processors</span><span class="p">.</span><span class="nx">until</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">processor</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">anode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="nx">ns</span> <span class="o">+</span> <span class="nx">processor</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The return value from the processor tells what to do next:</p>

<ul>
<li>null : remove node (replace with a marker)</li>
<li>false : do not process child nodes</li>
<li>node : replace for the current node (and stop processing)</li>
<li>fragment: replace for the current node (and stop processing)</li>
</ul>

<p>Any other return value (specially undefined) continues the normal
processing of the current node and its children.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Create a new dependency tracking context</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">bind</span><span class="p">.</span><span class="nx">tracking</span><span class="p">.</span><span class="nx">begin</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Run the processor against the current node</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">recurse</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">anode</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Stop capturing dependencies</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">deps</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">.</span><span class="nx">tracking</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Deps for &quot;%s(%s)&quot;: %o&#39;</span><span class="p">,</span> <span class="nx">processor</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">anode</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">deps</span><span class="p">);</span>


                    <span class="k">if</span> <span class="p">(</span><span class="nx">processor</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">CONTENT</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deps</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bound</span> <span class="o">&amp;&amp;</span> <span class="nx">deps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">exp</span> <span class="o">=</span> <span class="nx">anode</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snapshot</span><span class="p">)</span> <span class="nx">makeSnapshot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>

                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Binding content with %s&#39;</span><span class="p">,</span> <span class="nx">exp</span><span class="p">);</span>

                            <span class="nx">bound</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Restore the template children</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">backup</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Apply again the processor with the original expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">);</span>
                                <span class="nx">processor</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>TODO: The processor might want to have its child nodes
      processed. We need to trigger it here.</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>


                            <span class="p">},</span> <span class="p">{</span><span class="nx">ctx</span><span class="o">:</span> <span class="k">this</span><span class="p">}).</span><span class="nx">depends</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>

                            <span class="nx">bound</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> 
                                <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
                                <span class="k">while</span> <span class="p">(</span><span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span> <span class="o">!==</span> <span class="nx">p</span><span class="p">)</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">dispose</span><span class="p">()</span>
                                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;content bound disposed&#39;</span><span class="p">);</span>
                                    <span class="k">return</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;content bound called&#39;</span><span class="p">);</span> 
                            <span class="p">});</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">processor</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">REPLACE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deps</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bound</span> <span class="o">&amp;&amp;</span> <span class="nx">deps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Setting up computed...&#39;</span><span class="p">);</span>

                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snapshot</span><span class="p">)</span> <span class="nx">makeSnapshot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Make a snapshot of the current stack</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                            <span class="nx">snapshot</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">depth</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="nx">snapshot</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">k</span><span class="p">];</span>
                                <span class="p">}</span>
                            <span class="p">}</span>

                            <span class="nx">bound</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;backup: %o&#39;</span><span class="p">,</span> <span class="nx">backup</span><span class="p">);</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;node: %o&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Check if we're handling a section</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;begin&#39;</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="kd">var</span> <span class="nx">ident</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ident</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Remove all the siblings until we reach the end of the section</p>             </td>             <td class="code">               <div class="highlight"><pre>                                    <span class="k">while</span> <span class="p">(</span><span class="nx">nxt</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">nxt</span><span class="p">);</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">nxt</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;end&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ident</span> <span class="o">===</span> <span class="nx">ident</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="k">break</span><span class="p">;</span>
                                        <span class="p">}</span>
                                    <span class="p">};</span>
                                <span class="p">}</span>

                                <span class="kd">var</span> <span class="nx">newnode</span> <span class="o">=</span> <span class="nx">backup</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                                <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">newnode</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
                                <span class="nx">node</span> <span class="o">=</span> <span class="nx">newnode</span><span class="p">;</span>
                                <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                                <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">);</span>
                                <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

                            <span class="p">},</span> <span class="p">{</span><span class="nx">ctx</span><span class="o">:</span> <span class="k">this</span><span class="p">}).</span><span class="nx">depends</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
                            <span class="nx">bound</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;bound called&#39;</span><span class="p">);</span> <span class="p">});</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">&amp;&amp;</span> <span class="nx">deps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">bound</span><span class="p">.</span><span class="nx">depends</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">processor</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">)</span> <span class="p">{</span>

                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>By default we want to recurse any child nodes available</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">recurse</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>We want to remove this node</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">recurse</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">node</span> <span class="o">=</span> <span class="nx">insertMarker</span><span class="p">(</span><span class="nx">processor</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
                        <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>If the processor wants to replace the node we do so and stop.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">isNode</span><span class="p">(</span><span class="nx">recurse</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">recurse</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span> 
                            <span class="nx">node</span> <span class="o">=</span> <span class="nx">insertMarker</span><span class="p">(</span><span class="nx">processor</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">recurse</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">recurse</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
                            <span class="nx">node</span> <span class="o">=</span> <span class="nx">recurse</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>if the processor has removed the node then just exit</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span> <span class="o">||</span> <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">recurse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>find if the attribute is still there</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">anode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="nx">ns</span> <span class="o">+</span> <span class="nx">p</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>if the attribute is still there and not IE then remove it</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="cm">/*@cc_on!@*/</span><span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">anode</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttributeNode</span><span class="p">(</span> <span class="nx">anode</span> <span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>if no more attributes then we can stop looking for processors</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span> <span class="o">--</span><span class="nx">attrsNo</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">},</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Check remaining attributes to perform interpolation</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">attrsNo</span> <span class="o">=</span> <span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">attrsNo</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">p</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attrsNo</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!==</span> <span class="nx">p</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;${&#39;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attrsNo</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>check if we have to check the node's children</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">recurse</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>iterate over all the children with care since the DOM structure could change</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">child</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">next</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span> <span class="nx">child</span> <span class="p">);</span>
                <span class="nx">child</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>remove the current local data set since it has run out of scope</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <h2>tales</h2>

<p>Evaluates the given Tales expression returning the result.</p>

<ul>
<li>If the <em>default</em> keyword is found then <code>DomTal.DEFAULT</code> value is returned</li>
<li><p>If the <em>nothing</em> keyword is found then <code>DomTal.NOTHING</code> value is returned</p>

<p>var result = tpl.tales(['bool:path.to.variable', 'default']);</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tales</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exps</span><span class="p">,</span> <span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exps</span> <span class="o">||</span> <span class="o">!</span><span class="nx">exps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Empty tales expression&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">exp</span><span class="p">,</span>
        <span class="nx">m</span><span class="p">,</span> <span class="nx">mod</span><span class="p">,</span>
        <span class="nx">result</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span><span class="o">=</span><span class="nx">exps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">exp</span> <span class="o">=</span> <span class="nx">exps</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Check special keywords</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*default\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">exp</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*nothing\s*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">exp</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Find the desired tales prefix (modifier)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">mod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defMod</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="sr">/^\s*([\w_-]+)\s*:/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">exps</span><span class="p">[</span><span class="nx">i</span><span class="p">])))</span> <span class="p">{</span>
            <span class="nx">mod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">modifiers</span><span class="p">[</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown tales modifier &quot;&#39;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exps</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; | &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>

            <span class="nx">exp</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">exp</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>throw an error if we couldn't find a valid result</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">result</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Tales expression &quot;&#39;</span> <span class="o">+</span> <span class="nx">exps</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; | &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; resolved to an undefined value&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h2>load</h2>

<p>Prepares the given template to be used. Pass in as argument the template as a 
 string, a script tag node object wrapping the template contents, a node object
 defining the template as a DOM structure, a document fragment or an document
 element Id by prefixing it with '#'.</p>

<p>It will always return a document fragment with the template as a DOM structure
 or <code>false</code> if the template was not valid.</p>

<p>If the given template is not a document fragment this function will try to
 convert it to one. This operation can take some time so if you're repeatedly 
 loading the same template you should cache the result of this function once and 
 use that cached result in following calls.</p>

<pre><code> tpl.load( document.getElementById('myTemplate') );
 tpl.load( '#myTemplate' );
 tpl.load( '&lt;strong tal:content="username"&gt;drslump&lt;/strong&gt;' );
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">tpl</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">tpl</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tpl</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>fetch an element by its ID attribute</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>a string to convert to a document fragment</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringToDom</span><span class="p">(</span> <span class="nx">tpl</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">nodetype</span> <span class="o">===</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>a document fragment so use it directly</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="nx">tpl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;script&#39;</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>a script element so get the inline contents as a string and parse it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>filter out the comment or CDATA preffix and suffix</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*&lt;!(--|\[CDATA\[)/i</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(--|]])&gt;\s*$/i</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>convert the string to document fragment</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringToDom</span><span class="p">(</span> <span class="nx">tpl</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>a containing element so clone its contents</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">tpl</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>not a valid template source</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h2>run</h2>

<p>Parses the template and returns the final result. Optionally set the data to
 feed the template if not done already with the <code>set</code> method.</p>

<p>Returns a document fragment with the result of the template execution or false
 if an error happened.</p>

<pre><code> dom = tpl.run({foo:'Foo', bar:'Bar'});
 document.body.appendChild(out);
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No template was loaded, unable to perform the action&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Make a copy of the template and process it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h1>TAL Processors</h1>

<ul>
<li>Here are implemented the standard set of TAL processors. The order in
which they are defined is important so do not refactor it.</li>
<li><p>The functions are called with the <DomTal> object in the <em>this</em> variable
so you can use the methods from <DomTal>.</p>

<p>The functions take two arguments:</p></li>
<li>the first argument is the document element node in which that processor is
defined.</li>
<li>the second argument is the tales expression to parse</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeightedList</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Registers a new processor</p>

<p>TODO: Override existing processors with the same name</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">priority</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span> <span class="o">=</span> <span class="nx">priority</span><span class="p">;</span>
        <span class="nx">priority</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">AVERAGE</span><span class="p">;</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">processors</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
        <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
        <span class="nx">func</span><span class="o">:</span> <span class="nx">fn</span>
    <span class="p">},</span> <span class="nx">priority</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h2>define</h2>

<p>Defines one or more variables which may be used later in the template.
 To separate the variable definitions use a semi-colon. To declare a
 global variable use the <em>global</em> prefix, otherwise the variable will be
 declared as local and will only be available to the current node and
 its children.</p>

<pre><code> define="[global] VarName [TalesExpression|structure]"
</code></pre>

<ul>
<li>Empty elements with this processor are not removed from the template,
use <em>omit-tag</em> to accomplish that behaviour.</li>
<li>If no tales expression is supplied or it's <em>structure</em> then the
contents of the tag are assigned to the variable, in that case it'll be
added as a document fragment not as a string.</li>
</ul>

<p>Example of how to make a global shortcut to a long path</p>

<pre><code> &lt;span tal:define="global destname path/to/existing/variable" /&gt;
</code></pre>

<p>Assigning the contents of an element to a variable</p>

<pre><code> &lt;span tal:define="global myvar structure"
       tal:omit-tag="1"&gt;
   This is a &lt;strong&gt;string&lt;/strong&gt;
 &lt;/span&gt;
</code></pre>

<p>Defining a local variable</p>

<pre><code> &lt;span tal:define="myLocalVar js:new Array(10)"
       tal:repeat="item myLocalVar" tal:content="item"&gt;
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;define&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">MAX</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">def</span><span class="p">,</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">data</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>First is either the global keyword or the define name</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">def</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">ident</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">def</span> <span class="o">===</span> <span class="s1">&#39;global&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="nx">def</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">ident</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">def</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Expected an identifier at &#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="s1">&#39; in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Now comes a tales expression</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tales</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Expected a tales expression at &#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="s1">&#39; in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Copy and process child nodes if want to store the defaults</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">n</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">data</span><span class="p">[</span><span class="nx">def</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exp</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>process the child nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h2>condition</h2>

<p>The entity and its contents will be shown only if the expression
 evaluates to true.</p>

<pre><code> condition="TalesExpression"
</code></pre>

<p>The preferable way is to use boolean like variables</p>

<pre><code> &lt;span tal:condition="cart/isEmpty"&gt;
     No items in your cart
 &lt;/span&gt;
</code></pre>

<p>We can also use javascript code for special conditions</p>

<pre><code> &lt;span tal:condition="js: ${cart/items}.length &lt; 1"&gt;
     No items in your cart
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">VERYHIGH</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">REPLACE</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>

    <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tales</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Expected a tales expression in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">bind</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">value</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <h2>repeat</h2>

<p>Provides repetition for iterable data like arrays or objects. The repeat attribute 
 creates a new instance of its containing node for each item available in the 
 iterable structure.</p>

<pre><code> repeat="item TalesExpression"
</code></pre>

<p>Within the repetition, you can access the current loop information (and that of
 its parent for nested loops) using specific repeat/ paths. In the following table 
 <em>item</em> is the name of the receiver variable used in the repeat processor.</p>

<pre><code> repeat.item.index   - returns the item index (0 to count-1)
 repeat.item.number  - returns the item number (1 to count)
 repeat.item.even    - returns true if the item index is even
 repeat.item.odd     - returns true if the item index is odd
 repeat.item.start   - returns true if the item is the first one
 repeat.item.end     - returns true if the item is the last one
 repeat.item.length  - returns the number of elements in the resource
 repeat.item.key     - returns the item's key
</code></pre>

<p>One common use case of this processor is to populate a table with data</p>

<pre><code> &lt;table&gt;
 &lt;thead&gt;
   &lt;tr&gt;
     &lt;th&gt;Position&lt;/th&gt; &lt;th&gt;Player&lt;/th&gt; &lt;th&gt;Score&lt;/th&gt;
    &lt;/tr&gt;
   &lt;/thead&gt;
   &lt;tbody&gt;
     &lt;tr tal:repeat="ranking playersRanking"&gt;
       &lt;td tal:content="repeat.ranking.index"/&gt;
       &lt;td tal:content="ranking.player"/&gt;
       &lt;td tal:content="ranking.score"/&gt;
     &lt;/tr&gt;
   &lt;/tbody&gt;
 &lt;/table&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">HIGH</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">REPLACE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">tpl</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Store the node as a template</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>if we are in a loop then process its children normally</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">tpl</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;domtal_repeat&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">tpl</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="s1">&#39;domtal_repeat&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>mark the node as a repeated item template</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tpl</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;domtal_repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Parse the expression, an identifier followed by a tales expression</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>
    <span class="nx">item</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">ident</span><span class="p">();</span>
    <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>

    <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeIterable</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">)</span> <span class="p">);</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span> <span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Initialize the meta data object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">meta</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">repeat</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Create a fragment to hold all the repetitions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Loop over all the data set</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Update the meta information</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">meta</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">number</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">odd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="nx">i</span><span class="o">%</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">even</span> <span class="o">=</span> <span class="o">!</span><span class="nx">meta</span><span class="p">.</span><span class="nx">odd</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">===</span> <span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">len</span><span class="p">;</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="nx">tpl</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Process the template</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">fragment</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <h2>replace</h2>

<p>Replaces the containing node with the result of an expression, even if the expression
 resolves to an empty value.</p>

<pre><code> &lt;span tal:replace="myvar"&gt;
   This text will be replaced by the contents of myvar
   even removing the span tag around it
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">ABOVE</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">REPLACE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>
    <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>

    <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>check if we want to include a DOM Node or fragment</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h2>content</h2>

<p>Sets new contents for the containing node.</p>

<pre><code> &lt;span tal:content="myvar"&gt;
   This text will be replaced by the contents of myvar
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">AVERAGE</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">CONTENT</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>
    <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>

    <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>check if we want to include a DOM Node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="cm">/*@cc_on!@*/</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <h2>attributes</h2>

<p>Defines or overrides attributes in the current node.</p>

<pre><code> attributes="name TalesExpression [; name TalesExpression]"
</code></pre>

<p>You can separate the name and the tales expression either by an space, with a colon ':'
 or with an equal '='. Attributes can be separated by using a semi-colon ';' or just a
 simple comma ','.</p>

<pre><code> &lt;a href="http://www.foo.com"
    tal:attributes="href link.url; style 'color: red; background: yellow'"&gt;
      This link will point to ${link.url} with red text over a yellow background
 &lt;/a&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;attributes&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">LOW</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>

    <span class="k">do</span> <span class="p">{</span>

        <span class="nx">attr</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">rex</span><span class="p">(</span><span class="sr">/^\s*([a-z][a-z0-9_:-]*)/i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">attr</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Expected attribute name at &#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="s1">&#39; in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>It's not in the spec but we optionally support a colon or equal as separator.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">exp</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
        <span class="nx">exp</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>

        <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">tales</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Expected tales expression at &#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="s1">&#39; in &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Work around IE bug (http://webbugtrack.blogspot.com/2007/11/bug-299-setattribute-checked-does-not.html)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="cm">/*@cc_on!@*/</span><span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;checked&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">attr</span> <span class="o">=</span> <span class="s1">&#39;defaultChecked&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">tales</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">attr</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">);</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <h2>omit-tag</h2>

<p>Makes the parser skip the containing node if no expression is given or if it evaluates 
 to true. The contents of the tag will however be parsed and included in the output.</p>

<pre><code> &lt;span tal:omit-tag="myvar"&gt;
     If myvar evaluates to true this text will appear without the span 
     tag surrounding it
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="s1">&#39;omit-tag&#39;</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PRIO</span><span class="p">.</span><span class="nx">VERYLOW</span><span class="p">,</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">PROCTYPE</span><span class="p">.</span><span class="nx">REPLACE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">exp</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">tales</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressionParser</span><span class="p">(</span><span class="nx">exp</span><span class="p">);</span>
    <span class="nx">tales</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">tales</span><span class="p">();</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">tales</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Move the children to a fragment so we can replace this node with them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">value</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <h1>TALES modifiers</h1>

<h2>Expression chains</h2>

<p>An expression chain is a list of expressions separated by the '|' character.
 While evaluating those expressions, DOM TAL will stop its evaluation when an
 expression value is not null and no error was raised.</p>

<pre><code> "page.title | page.alternativeTitle | 'No Title'"
</code></pre>

<h2>The <em>default</em> keyword</h2>

<p>This allows template designers to keep the content of a tag as an
 alternative value if an error occurs or if something is not defined. It
 should be used as the last element of an <em>expression chain</em>.</p>

<pre><code> &lt;h1 tal:content="page.title | default"&gt;
     This title will be shown if page/title is empty
 &lt;/h1&gt;
</code></pre>

<h2>Extending</h2>

<p>You can create your own modifiers by extending the DomTal.modifiers
 object. The modifier functions take as only argument the tales expression
 to evaluate.</p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DomTal</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modifiers</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <h2>path</h2>

<p><em>Deprecated</em>. The default modifier is now to evaluate the expression as
 a Javascript statement.</p>

<p>We still support this modifier for historical reasons since it's the
 default one in most Tal implementations. It will convert the expression
 to a javascript statement replace forward slashes '/' by dots '.'. </p>

<pre><code> &lt;span tal:content="path: user.name" /&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">path</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_path</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">]);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h2>exists</h2>

<p>This modifier returns true if the given path exists or false if it does
 not.</p>

<pre><code> &lt;span tal:condition="exists: user"&gt;
     Welcome ${user.name}
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">exists</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_exists</span><span class="p">(</span> <span class="nx">exp</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h2>not</h2>

<p>This modifier just negates the result of the given expression. It's
 specially useful when used in the <em>condition</em> processor.</p>

<pre><code> &lt;span tal:condition="not: cart.items"&gt;
   There are no items in your cart
 &lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">not</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_not</span><span class="p">(</span> <span class="nx">exp</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <h2>string</h2>

<p><em>Deprecated</em>. This prefix is no longer available.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">string</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_string</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The &quot;string:&quot; prefix has been deprecated&#39;</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <h2>js</h2>

<p>This modifier evaluates the expression as plain Javascript code after
 interpolating the expression for any variables.</p>

<p>Try to not abuse this modifier, the code is passed thru eval() which
 would make its debugging more difficult. Moreover, the tales parser is
 quite weak so it's possible that any non simple javascript literal could
 break it.
 If you need a special functionality try creating a custom modifier, they
 are very easy to implement and should also be a bit faster than eval'd
 code.</p>

<p>This will make a list with 10 items in it from 0 to 9</p>

<pre><code> &lt;ul tal:repeat="elem [0,1,2,3,4,5,6,7,8,9]"&gt;
     &lt;li tal:content="repeat.elem.index" /&gt;
 &lt;/ul&gt;
</code></pre>

<p>This will do the same but the number of items is defined in a variable</p>

<pre><code> &lt;ul tal:repeat="elem new Array(path.to.numItems)"&gt;
     &lt;li tal:content="repeat.elem.index" /&gt;
 &lt;/ul&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">js</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">rex</span> <span class="o">=</span> <span class="sr">/([&#39;&quot;\/\\\.])|([A-Za-z$_]+)/g</span><span class="p">,</span>
            <span class="nx">keywords</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;continue&#39;</span><span class="p">,</span>
                <span class="s1">&#39;debugger&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;do&#39;</span><span class="p">,</span>
                <span class="s1">&#39;else&#39;</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;finally&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
                <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;instanceof&#39;</span><span class="p">,</span>
                <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;switch&#39;</span><span class="p">,</span>
                <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;throw&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;try&#39;</span><span class="p">,</span> <span class="s1">&#39;typeof&#39;</span><span class="p">,</span>
                <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;void&#39;</span><span class="p">,</span> <span class="s1">&#39;while&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span>
            <span class="p">];</span>

        <span class="kd">function</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">quoted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">backslash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">dot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rex</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m0</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">ident</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">switch</span> <span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;\\&#39;</span><span class="o">:</span>
                        <span class="nx">backslash</span> <span class="o">=</span> <span class="o">!</span><span class="nx">backslash</span><span class="p">;</span>
                        <span class="nx">dot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">ch</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;.&#39;</span><span class="o">:</span> 
                        <span class="nx">backslash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">dot</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">ch</span><span class="p">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quoted</span><span class="p">)</span> <span class="nx">quoted</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">;</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">quoted</span> <span class="o">===</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">backslash</span><span class="p">)</span> <span class="nx">quoted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">backslash</span> <span class="o">=</span> <span class="nx">dot</span> <span class="o">=</span> <span class="kc">false</span>
                        <span class="k">return</span> <span class="nx">ch</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ident</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">dot</span> <span class="o">||</span> <span class="nx">quoted</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span> <span class="o">!==</span> <span class="nx">keywords</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ident</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">backslash</span> <span class="o">=</span> <span class="nx">dot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">ident</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">backslash</span> <span class="o">=</span> <span class="nx">dot</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">return</span> <span class="s2">&quot;(THIS.get(&#39;&quot;</span> <span class="o">+</span> <span class="nx">ident</span> <span class="o">+</span> <span class="s2">&quot;&#39;, THIS.env[&#39;&quot;</span> <span class="o">+</span> <span class="nx">ident</span> <span class="o">+</span> <span class="s2">&quot;&#39;]))&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> 
            <span class="nx">cache</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">js</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span> <span class="k">in</span> <span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">exp</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Optimize the simplest case which is just obtaining a top level variable</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="sr">/^[A-Za-z$_][A-Za-z0-9$_]*$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">exp</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">exp</span><span class="p">]);</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Create a function instead of evaling the compiled code since Function is
safer and is supposed to be easier to optimize by Javascript engines.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">fn</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">exp</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;THIS&#39;</span><span class="p">,</span> <span class="s1">&#39;return (&#39;</span> <span class="o">+</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Try to clean up the error message a bit</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\(*THIS\.get\([&#39;&quot;]([^&#39;&quot;]+)[^)]+\)+/g</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Wrap the exception with our own to customize the message</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s1">&#39;. Evaluating tales expression &quot;&#39;</span> <span class="o">+</span> <span class="nx">exp</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
            <span class="nx">err</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <h2>structure</h2>

<p>Indicates that we want to use the contens without escaping especial characters.
 In standard Tal implementations <code>structure</code> is a keyword instead of a modifier.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">structure</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_structure</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>

        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringToDom</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <h2>html</h2>

<p>Just an alias to the structure modifier</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">html</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_html</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">modifiers</span><span class="p">.</span><span class="nx">structure</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">exp</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <h2>bool</h2>

<p>This modifier casts the expression value to a boolean. It understands strings
 with Yes/No, On/Off and True/False. A string of '0' is casted to false.</p>

<pre><code> &lt;input type="checkbox" tal:attributes="checked bool:user.active" /&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">bool</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_bool</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>

        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="sr">/^[0-9\.]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/^(no|off|false)$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="o">!!</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <h2>int</h2>

<p>This modifier casts the expression value to an integer</p>

<pre><code> &lt;span&gt;${int:user.age}&lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;int&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_int</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>

        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <h2>float</h2>

<p>This modifier casts the expression value to a float </p>

<pre><code> &lt;span&gt;${float:item.ratio}&lt;/span&gt;&lt;/span&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;float&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">DomTal_modifiers_float</span><span class="p">(</span><span class="nx">exp</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>

        <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tales</span><span class="p">([</span><span class="nx">exp</span><span class="p">]);</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="mf">0.0</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <h1>Exports</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">DomTal</span> <span class="o">=</span> <span class="nx">DomTal</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">DomTal</span><span class="p">.</span><span class="nx">ExpressionParser</span> <span class="o">=</span> <span class="nx">ExpressionParser</span><span class="p">;</span>


<span class="p">})(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">exports</span> <span class="o">:</span> <span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 